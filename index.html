<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Radio Guaka</title>
  <link rel="icon" type="image/png" href="favicon.ico">
  <link rel="stylesheet" href="style.css">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="radioApp()" x-init="init()">
  <div class="container">
    <!-- Player Header -->
    <header>
      <div class="container">
        <h2>
          <span class="logo-icon">ğŸ“»</span>
          radio guaka
        </h2>

        <template x-if="srcUrl">
          <div>
            <audio preload="auto" id="player" controls :src="srcUrl" x-ref="audioPlayer">
            </audio>

            <div>
              <span>ğŸ“¶</span>
              <span id="networkState"></span>
              <span>â±</span>
              <span id="readyState"></span>
            </div>
          </div>
        </template>
      </div>
    </header>

    <!-- Main Content -->
    <article>
      <div class="container">
        <div id="channels" style="clear:both">
          <a href="#" 
             @click.prevent="navigateTo('#')"
             class="btn btn-large"
             :class="currentChannel ? 'btn-danger' : 'btn-success'"
             id="stop"
             title="Stop">
            â¹ Stop
          </a>
          
          <template x-for="channel in sortedChannels" :key="channel.name">
            <a href="#"
               @click.prevent="navigateTo('#' + channel.name)"
               class="channel btn btn-large"
               :class="channel.playing ? 'btn-success' : 'btn-primary'">
              <span x-text="channel.name"></span>
            </a>
          </template>
        </div>

        <template x-if="currentChannelData">
          <div>
            <h1><span x-text="currentChannelData.name"></span></h1>
            <div id="metadata">
              <template x-if="currentChannelData.site">
                <a :href="currentChannelData.site" target="_blank" x-text="currentChannelData.site"></a>
              </template>
              <template x-if="currentChannelData.facebook">
                <a :href="currentChannelData.facebook" target="_blank">ğŸ“˜ Facebook</a>
              </template>
            </div>
          </div>
        </template>

        <template x-if="!currentChannel">
          <div class="welcome">
            Welcome to Radio Guaka. Click on a channel to listen, use left
            and right keys, or use Alt+letter to change channels.
          </div>
        </template>
      </div>
    </article>
    
    <!-- Footer -->
    <footer>
      <div class="container">
        <p>
          âŒ¨ shortcuts:
          Change volume â†‘ â†“
          Change channels â† â†’
          or Alt key plus first letter of the name. â¹ space bar.

          &mdash;
          <strong>Radio Guaka</strong> is a convenient way to listen to quality <a target="_blank" href="https://moneyless.org/tags/advertising">ad free</a> internet radio streams.
          &mdash;
          <a target="_blank" href="https://github.com/guaka/radio-meteor/"><span>ğŸ“¦</span></a> <a target="_blank" href="https://github.com/guaka/radio">free software</a>
        </p>
      </div>
    </footer>
  </div>

  <script src="channels.js"></script>
  <script src="app.js"></script>
  <script>
    function radioApp() {
      return {
        currentChannel: '',
        
        init() {
          // Make appState available globally for app.js
          window.appState = this;
          
          // Verify channels are loaded
          if (typeof channels === 'undefined') {
            console.error('channels.js not loaded! Make sure channels.js is loaded before this script.');
            return;
          }
          
          console.log('Loaded channels:', Object.keys(channels).length);
          
          // Wait for router to be initialized by app.js
          const checkRouter = () => {
            if (window.router) {
              window.router.handleRoute();
            } else {
              setTimeout(checkRouter, 50);
            }
          };
          checkRouter();
        },
        
        navigateTo(hash) {
          if (window.router) {
            // Convert hash format to path format for router.navigate()
            const path = hash === '#' ? '/' : '/' + hash.slice(1);
            window.router.navigate(path);
          } else {
            window.location.hash = hash;
          }
        },
        
        get sortedChannels() {
          if (typeof channels === 'undefined') {
            console.error('channels is not defined');
            return [];
          }
          return Object.keys(channels)
            .sort()
            .map(name => ({
              name: name,
              playing: name === this.currentChannel
            }));
        },
        
        get currentChannelData() {
          if (!this.currentChannel) return null;
          
          const channel = channels[this.currentChannel];
          if (!channel) return null;
          
          const data = { ...channel, name: this.currentChannel };
          
          // Set SomaFM metadata if needed
          if (channel.tags && channel.tags.indexOf('soma') > -1) {
            data.site = 'http://somafm.com/';
            data.facebook = 'https://facebook.com/somafm';
          }
          
          return data;
        },
        
        get srcUrl() {
          if (!this.currentChannel) return null;
          
          if (typeof channels === 'undefined') {
            console.error('channels is not defined');
            return null;
          }
          
          const channel = channels[this.currentChannel];
          if (!channel) return null;
          
          // SomaFM streams use a pattern
          if (channel.tags && channel.tags.indexOf('soma') > -1) {
            return 'http://ice.somafm.com/' + this.currentChannel;
          }
          
          return channel.url || null;
        }
      };
    }
  </script>
</body>
</html>

